use mmu::Memory;

fn invalid_inst(op: u8) -> String {
    format!("0x{:2X}", op)
}

pub fn disasm(mut addr: u16, mem: &mut Memory) -> String {
    macro_rules! get_n { () => ({ addr += 1; mem.lb(addr - 1) }) }
    macro_rules! get_ni { () => (get_n!() as i8) }
    macro_rules! get_nn { () => (get_n!() as u16 + (get_n!() as u16 << 8)) }

    let op = mem.lb(addr);
    addr += 1;

    match op {
        0x00 => format!("nop"),
        0x01 => format!("ld\tbc, {}", get_nn!()),
        0x02 => format!("ld\t(bc), a"),
        0x03 => format!("inc\tbc"),
        0x04 => format!("inc\tb"),
        0x05 => format!("dec\tb"),
        0x06 => format!("ld\tb, {}", get_n!()),
        0x07 => format!("rlca"),
        0x08 => format!("ld\t({:X}h), sp", get_nn!()),
        0x09 => format!("add\thl, bc"),
        0x0A => format!("ld\ta, (bc)"),
        0x0B => format!("dec\tbc"),
        0x0C => format!("inc\tc"),
        0x0D => format!("dec\tc"),
        0x0E => format!("ld\tc, {}", get_n!()),
        0x0F => format!("rrca"),

        0x10 => format!("stop"),
        0x11 => format!("ld\tde, {}", get_nn!()),
        0x12 => format!("ld\t(de), a"),
        0x13 => format!("inc\tde"),
        0x14 => format!("inc\td"),
        0x15 => format!("dec\td"),
        0x16 => format!("ld\td, {}", get_n!()),
        0x17 => format!("rla"),
        0x18 => format!("jr\t{}", get_ni!()),
        0x19 => format!("add\thl, de"),
        0x1A => format!("ld\ta, (de)"),
        0x1B => format!("dec\tde"),
        0x1C => format!("inc\te"),
        0x1D => format!("dec\te"),
        0x1E => format!("ld\te, {}", get_n!()),
        0x1F => format!("rra"),

        0x20 => format!("jr\tnz, {}", get_ni!()),
        0x21 => format!("ld\thl, {}", get_nn!()),
        0x22 => format!("ld\t(hl), a"),
        0x23 => format!("inc\thl"),
        0x24 => format!("inc\th"),
        0x25 => format!("dec\th"),
        0x26 => format!("ld\th, {}", get_n!()),
        0x27 => format!("daa"),
        0x28 => format!("jr\tz, {}", get_ni!()),
        0x29 => format!("add\thl, hl"),
        0x2A => format!("ld\ta, (hl)"),
        0x2B => format!("dec\thl"),
        0x2C => format!("inc\tl"),
        0x2D => format!("dec\tl"),
        0x2E => format!("ld\tl, {}", get_n!()),
        0x2F => format!("cpl"),

        0x30 => format!("jr\tnc, {}", get_ni!()),
        0x31 => format!("ld\tsp, ({:X})", get_nn!()),
        0x32 => format!("ldd\t(hl), a"),
        0x33 => format!("inc\tsp"),
        0x34 => format!("inc\t(hl)"),
        0x35 => format!("dec\t(hl)"),
        0x36 => format!("ld\t(hl), {}", get_n!()),
        0x37 => format!("scf"),
        0x38 => format!("jr\tc, {}", get_ni!()),
        0x39 => format!("add\thl, sp"),
        0x3A => format!("ldd\ta, (hl)"),
        0x3B => format!("dec\tsp"),
        0x3C => format!("inc\ta"),
        0x3D => format!("dec\ta"),
        0x3E => format!("ld\ta, {}", get_n!()),
        0x3F => format!("ccf"),

        0x40 => format!("ld\tb, b"),
		0x41 => format!("ld\tb, c"),
        0x42 => format!("ld\tb, d"),
        0x43 => format!("ld\tb, e"),
        0x44 => format!("ld\tb, h"),
        0x45 => format!("ld\tb, l"),
        0x46 => format!("ld\tb, (hl)"),
        0x47 => format!("ld\tb, a"),
        0x48 => format!("ld\tc, b"),
        0x49 => format!("ld\tc, c"),
        0x4A => format!("ld\tc, d"),
        0x4B => format!("ld\tc, e"),
        0x4C => format!("ld\tc, h"),
        0x4D => format!("ld\tc, hl"),
        0x4E => format!("ld\tc, (hl)"),
        0x4F => format!("ld\tc, a"),

        0x50 => format!("ld\td, b"),
        0x51 => format!("ld\td, c"),
        0x52 => format!("ld\td, d"),
        0x53 => format!("ld\td, e"),
        0x54 => format!("ld\td, h"),
        0x55 => format!("ld\td, l"),
        0x56 => format!("ld\td, (hl)"),
        0x57 => format!("ld\td, a"),
        0x58 => format!("ld\te, b"),
        0x59 => format!("ld\te, c"),
        0x5A => format!("ld\te, d"),
        0x5B => format!("ld\te, e"),
        0x5C => format!("ld\te, h"),
        0x5D => format!("ld\te, l"),
        0x5E => format!("ld\te, (hl)"),
        0x5F => format!("ld\te, a"),

        0x60 => format!("ld\th, b"),
        0x61 => format!("ld\th, c"),
        0x62 => format!("ld\th, d"),
        0x63 => format!("ld\th, e"),
        0x64 => format!("ld\th, h"),
        0x65 => format!("ld\th, l"),
        0x66 => format!("ld\th, (hl)"),
        0x67 => format!("ld\th, a"),
        0x68 => format!("ld\tl, b"),
        0x69 => format!("ld\tl, c"),
        0x6A => format!("ld\tl, d"),
        0x6B => format!("ld\tl, e"),
        0x6C => format!("ld\tl, h"),
        0x6D => format!("ld\tl, l"),
        0x6E => format!("ld\tl, (hl)"),
        0x6F => format!("ld\tl, a"),

        0x70 => format!("ld\t(hl), b"),
        0x71 => format!("ld\t(hl), c"),
        0x72 => format!("ld\t(hl), d"),
        0x73 => format!("ld\t(hl), e"),
        0x74 => format!("ld\t(hl), h"),
        0x75 => format!("ld\t(hl), l"),
        0x76 => format!("halt"),
        0x77 => format!("ld\t(hl), a"),
        0x78 => format!("ld\ta, b"),
        0x79 => format!("ld\ta, c"),
        0x7A => format!("ld\ta, d"),
        0x7B => format!("ld\ta, e"),
        0x7C => format!("ld\ta, h"),
        0x7D => format!("ld\ta, l"),
        0x7E => format!("ld\ta, (hl)"),
        0x7F => format!("ld\ta, a"),

        0x80 => format!("add\ta, b"),
        0x81 => format!("add\ta, c"),
        0x82 => format!("add\ta, d"),
        0x83 => format!("add\ta, e"),
        0x84 => format!("add\ta, h"),
        0x85 => format!("add\ta, l"),
        0x86 => format!("add\ta, (hl)"),
        0x87 => format!("add\ta, a"),
        0x88 => format!("adc\ta, b"),
        0x89 => format!("adc\ta, c"),
        0x8A => format!("adc\ta, d"),
        0x8B => format!("adc\ta, e"),
        0x8C => format!("adc\ta, h"),
        0x8D => format!("adc\ta, l"),
        0x8E => format!("adc\ta, (hl)"),
        0x8F => format!("adc\ta"),

        0x90 => format!("sub\ta, b"),
        0x91 => format!("sub\ta, c"),
        0x92 => format!("sub\ta, d"),
        0x93 => format!("sub\ta, e"),
        0x94 => format!("sub\ta, h"),
        0x95 => format!("sub\ta, l"),
        0x96 => format!("sub\ta, (hl)"),
        0x97 => format!("sub\ta, a"),
        0x98 => format!("suc\ta, b"),
        0x99 => format!("suc\ta, c"),
        0x9A => format!("suc\ta, d"),
        0x9B => format!("suc\ta, e"),
        0x9C => format!("suc\ta, h"),
        0x9D => format!("suc\ta, l"),
        0x9E => format!("sbc\ta, (HL)"),
        0x9F => format!("suc\ta, a"),

        0xA0 => format!("and\ta, b"),
        0xA1 => format!("and\ta, c"),
        0xA2 => format!("and\ta, d"),
        0xA3 => format!("and\ta, e"),
        0xA4 => format!("and\ta, h"),
        0xA5 => format!("and\ta, l"),
        0xA6 => format!("and\ta, (hl)"),
        0xA7 => format!("and\ta, a"),
        0xA8 => format!("xor\ta, b"),
        0xA9 => format!("xor\ta, c"),
        0xAA => format!("xor\ta, d"),
        0xAB => format!("xor\ta, e"),
        0xAC => format!("xor\ta, h"),
        0xAD => format!("xor\ta, l"),
        0xAE => format!("xor\ta, (hl)"),
        0xAF => format!("xor\ta, a"),

        0xB1 => format!("or\ta, c"),
        0xB2 => format!("or\ta, d"),
        0xB0 => format!("or\ta, b"),
        0xB3 => format!("or\ta, e"),
        0xB4 => format!("or\ta, h"),
        0xB5 => format!("or\ta, l"),
        0xB6 => format!("or\ta, (hl)"),
        0xB7 => format!("or\ta, a"),
        0xB8 => format!("cp\ta, b"),
        0xB9 => format!("cp\ta, c"),
        0xBA => format!("cp\ta, d"),
        0xBB => format!("cp\ta, e"),
        0xBC => format!("cp\ta, h"),
        0xBD => format!("cp\ta, l"),
        0xBE => format!("cp\ta, (hl)"),
        0xBF => format!("cp\ta, a"),

        0xC0 => format!("ret\tnz"),
        0xC1 => format!("pop\tbc"),
        0xC2 => format!("jp\tnz, {:X}h", get_nn!()),
        0xC3 => format!("jp\t{:X}h", get_nn!()),
        0xC4 => format!("call\tnz, {:X}h", get_nn!()),
        0xC5 => format!("push\tbc"),
        0xC6 => format!("add\ta, {}", get_n!()),
        0xC7 => format!("rst\t00h"),
        0xC8 => format!("ret\tz"),
        0xC9 => format!("ret"),
        0xCA => format!("jp\tz, {:X}h", get_nn!()),
        0xCB => disasm_long(addr, mem),
        0xCC => format!("call\tz, {:X}h", get_nn!()),
        0xCD => format!("call\t{:X}h", get_nn!()),
        0xCE => format!("adc\ta, {:X}h", get_n!()),
        0xCF => format!("rst\t08h"),

        0xD0 => format!("ret\tnc"),
        0xD1 => format!("pop\tde"),
        0xD2 => format!("jp\tnc, {:X}h", get_nn!()),
        0xD3 => invalid_inst(op),
        0xD4 => format!("call\tc, {:X}h", get_nn!()),
        0xD5 => format!("push\tde"),
        0xD6 => format!("add\ta, {}", get_n!()),
        0xD7 => format!("rst\t10h"),
        0xD8 => format!("ret\tc"),
        0xD9 => format!("reti"),
        0xDA => format!("jp\tc, {:X}h", get_nn!()),
        0xDB => invalid_inst(op),
        0xDC => format!("call\tc, {:X}h", get_nn!()),
        0xDD => invalid_inst(op),
        0xDE => format!("sbc\ta, {:X}h", get_n!()),
        0xDF => format!("rst\t18h"),

        0xE0 => format!("ld\t(FF00+{:X}h), a", get_n!()),
        0xE1 => format!("pop\thl"),
        0xE2 => format!("ld\t(FF00+C), a"),
        0xE3 => invalid_inst(op),
        0xE4 => invalid_inst(op),
        0xE5 => format!("push\thl"),
        0xE6 => format!("and\ta, {}", get_n!()),
        0xE7 => format!("rst\t20h"),
        0xE8 => format!("add\tsp, {}", get_n!()),
        0xE9 => format!("jp\thl"),
        0xEA => format!("ld\t({:X}h), a", get_nn!()),
        0xEB => invalid_inst(op),
        0xEC => invalid_inst(op),
        0xED => invalid_inst(op),
        0xEE => format!("xor\ta, {}",get_n!()),
        0xEF => format!("rst\t28h"),

        0xF0 => format!("ld\ta, (FF00+{:X}h)", get_n!()),
        0xF1 => format!("pop\taf"),
        0xF2 => format!("ld\ta, (FF00+C)"),
        0xF3 => format!("di"),
        0xF4 => invalid_inst(op),
        0xF5 => format!("push\taf"),
        0xF6 => format!("or\ta, {}", get_n!()),
        0xF7 => format!("rst\t30h"),
        0xF8 => format!("ld\thl, sp+{}", get_ni!()),
        0xF9 => format!("ld\tsp, hl"),
        0xFA => format!("ld\ta, ({:X}h)", get_nn!()),
        0xFB => format!("ei"),
        0xFC => invalid_inst(op),
        0xFD => invalid_inst(op),
        0xFE => format!("cp\ta, {}", get_n!()),
        0xFF => format!("rst\t38h"),

         _ => unreachable!()
    }
}

fn disasm_long(addr: u16, mem: &mut Memory) -> String{
    let op = mem.lb(addr);

    match op {
        0x00 => format!("rlc\tb"),
        0x01 => format!("rlc\tc"),
        0x02 => format!("rlc\td"),
        0x03 => format!("rlc\te"),
        0x04 => format!("rlc\th"),
        0x05 => format!("rlc\tl"),
        0x06 => format!("rlc\t(HL)"),
        0x07 => format!("rlc\ta"),
        0x08 => format!("rrc\tb"),
        0x09 => format!("rrc\tc"),
        0x0A => format!("rrc\td"),
        0x0B => format!("rrc\te"),
        0x0C => format!("rrc\th"),
        0x0D => format!("rrc\tl"),
        0x0E => format!("rrc\t(HL)"),
        0x0F => format!("rrc\ta"),

        0x10 => format!("rl\tb"),
        0x11 => format!("rl\tc"),
        0x12 => format!("rl\td"),
        0x13 => format!("rl\te"),
        0x14 => format!("rl\th"),
        0x15 => format!("rl\tl"),
        0x16 => format!("rl\t(HL)"),
        0x17 => format!("rl\ta"),
        0x18 => format!("rr\tb"),
        0x19 => format!("rr\tc"),
        0x1A => format!("rr\td"),
        0x1B => format!("rr\te"),
        0x1C => format!("rr\th"),
        0x1D => format!("rr\tl"),
        0x1E => format!("rr\t(HL)"),
        0x1F => format!("rr\ta"),

        0x20 => format!("sla\tb"),
        0x21 => format!("sla\tc"),
        0x22 => format!("sla\td"),
        0x23 => format!("sla\te"),
        0x24 => format!("sla\th"),
        0x25 => format!("sla\tl"),
        0x26 => format!("sla\t(HL)"),
        0x27 => format!("sla\ta"),
        0x28 => format!("sra\tb"),
        0x29 => format!("sra\tc"),
        0x2A => format!("sra\td"),
        0x2B => format!("sra\te"),
        0x2C => format!("sra\th"),
        0x2D => format!("sra\tl"),
        0x2E => format!("sra\t(HL)"),
        0x2F => format!("sra\ta"),

        0x30 => format!("swap\tb"),
        0x31 => format!("swap\tc"),
        0x32 => format!("swap\td"),
        0x33 => format!("swap\te"),
        0x34 => format!("swap\th"),
        0x35 => format!("swap\tl"),
        0x36 => format!("swap\t(HL)"),
        0x37 => format!("swap\ta"),
        0x38 => format!("srl\tb"),
        0x39 => format!("srl\tc"),
        0x3A => format!("srl\td"),
        0x3B => format!("srl\te"),
        0x3C => format!("srl\th"),
        0x3D => format!("srl\tl"),
        0x3E => format!("srl\t(HL)"),
        0x3F => format!("srl\ta"),

        0x40 => format!("bit\t0, b"),
        0x41 => format!("bit\t0, c"),
        0x42 => format!("bit\t0, d"),
        0x43 => format!("bit\t0, e"),
        0x44 => format!("bit\t0, h"),
        0x45 => format!("bit\t0, l"),
        0x46 => format!("bit\t0, (hl)"),
        0x47 => format!("bit\t0, a"),
        0x48 => format!("bit\t1, b"),
        0x49 => format!("bit\t1, c"),
        0x4A => format!("bit\t1, d"),
        0x4B => format!("bit\t1, e"),
        0x4C => format!("bit\t1, h"),
        0x4D => format!("bit\t1, l"),
        0x4E => format!("bit\t1, (hl)"),
        0x4F => format!("bit\t1, a"),

        0x50 => format!("bit\t2, b"),
        0x51 => format!("bit\t2, c"),
        0x52 => format!("bit\t2, d"),
        0x53 => format!("bit\t2, e"),
        0x54 => format!("bit\t2, h"),
        0x55 => format!("bit\t2, l"),
        0x56 => format!("bit\t2, (hl)"),
        0x57 => format!("bit\t2, a"),
        0x58 => format!("bit\t3, b"),
        0x59 => format!("bit\t3, c"),
        0x5A => format!("bit\t3, d"),
        0x5B => format!("bit\t3, e"),
        0x5C => format!("bit\t3, h"),
        0x5D => format!("bit\t3, l"),
        0x5E => format!("bit\t3, (hl)"),
        0x5F => format!("bit\t3, a"),

        0x60 => format!("bit\t4, b"),
        0x61 => format!("bit\t4, c"),
        0x62 => format!("bit\t4, d"),
        0x63 => format!("bit\t4, e"),
        0x64 => format!("bit\t4, h"),
        0x65 => format!("bit\t4, l"),
        0x66 => format!("bit\t4, (hl)"),
        0x67 => format!("bit\t4, a"),
        0x68 => format!("bit\t5, b"),
        0x69 => format!("bit\t5, c"),
        0x6A => format!("bit\t5, d"),
        0x6B => format!("bit\t5, e"),
        0x6C => format!("bit\t5, h"),
        0x6D => format!("bit\t5, l"),
        0x6E => format!("bit\t5, (hl)"),
        0x6F => format!("bit\t5, a"),

        0x70 => format!("bit\t6, b"),
        0x71 => format!("bit\t6, b"),
        0x72 => format!("bit\t6, b"),
        0x73 => format!("bit\t6, b"),
        0x74 => format!("bit\t6, b"),
        0x75 => format!("bit\t6, b"),
        0x76 => format!("bit\t6, (hl)"),
        0x77 => format!("bit\t6, a"),
        0x78 => format!("bit\t7, b"),
        0x79 => format!("bit\t7, c"),
        0x7A => format!("bit\t7, d"),
        0x7B => format!("bit\t7, e"),
        0x7C => format!("bit\t7, j"),
        0x7D => format!("bit\t7, l"),
        0x7E => format!("bit\t7, (hl)"),
        0x7F => format!("bit\t7, a"),

        0x80 => format!("res\t0, b"),
        0x81 => format!("res\t0, c"),
        0x82 => format!("res\t0, d"),
        0x83 => format!("res\t0, e"),
        0x84 => format!("res\t0, h"),
        0x85 => format!("res\t0, l"),
        0x86 => format!("res\t0, (hl)"),
        0x87 => format!("res\t0, a"),
        0x88 => format!("res\t1, b"),
        0x89 => format!("res\t1, c"),
        0x8A => format!("res\t1, d"),
        0x8B => format!("res\t1, e"),
        0x8C => format!("res\t1, h"),
        0x8D => format!("res\t1, l"),
        0x8E => format!("res\t1, (hl)"),
        0x8F => format!("res\t1, a"),

        0x90 => format!("res\t2, b"),
        0x91 => format!("res\t2, c"),
        0x92 => format!("res\t2, d"),
        0x93 => format!("res\t2, e"),
        0x94 => format!("res\t2, h"),
        0x95 => format!("res\t2, l"),
        0x96 => format!("res\t2, (hl)"),
        0x97 => format!("res\t2, a"),
        0x98 => format!("res\t3, b"),
        0x99 => format!("res\t3, c"),
        0x9A => format!("res\t3, d"),
        0x9B => format!("res\t3, e"),
        0x9C => format!("res\t3, h"),
        0x9D => format!("res\t3, l"),
        0x9E => format!("res\t3, (hl)"),
        0x9F => format!("res\t3, a"),

        0xA0 => format!("res\t4, b"),
        0xA1 => format!("res\t4, c"),
        0xA2 => format!("res\t4, d"),
        0xA3 => format!("res\t4, e"),
        0xA4 => format!("res\t4, h"),
        0xA5 => format!("res\t4, l"),
        0xA6 => format!("res\t4, (hl)"),
        0xA7 => format!("res\t4, a"),
        0xA8 => format!("res\t5, b"),
        0xA9 => format!("res\t5, c"),
        0xAA => format!("res\t5, d"),
        0xAB => format!("res\t5, e"),
        0xAC => format!("res\t5, h"),
        0xAD => format!("res\t5, l"),
        0xAE => format!("res\t5, (hl)"),
        0xAF => format!("res\t5, a"),

        0xB0 => format!("res\t6, b"),
        0xB1 => format!("res\t6, c"),
        0xB2 => format!("res\t6, d"),
        0xB3 => format!("res\t6, e"),
        0xB4 => format!("res\t6, h"),
        0xB5 => format!("res\t6, l"),
        0xB6 => format!("res\t6, (hl)"),
        0xB7 => format!("res\t6, a"),
        0xB8 => format!("res\t7, b"),
        0xB9 => format!("res\t7, c"),
        0xBA => format!("res\t7, d"),
        0xBB => format!("res\t7, e"),
        0xBC => format!("res\t7, h"),
        0xBD => format!("res\t7, l"),
        0xBE => format!("res\t7, (hl)"),
        0xBF => format!("res\t7, a"),

        0xC0 => format!("set\t0, b"),
        0xC1 => format!("set\t0, c"),
        0xC2 => format!("set\t0, d"),
        0xC3 => format!("set\t0, e"),
        0xC4 => format!("set\t0, h"),
        0xC5 => format!("set\t0, l"),
        0xC6 => format!("set\t0, (hl)"),
        0xC7 => format!("set\t0, a"),
        0xC8 => format!("set\t1, b"),
        0xC9 => format!("set\t1, c"),
        0xCA => format!("set\t1, d"),
        0xCB => format!("set\t1, e"),
        0xCC => format!("set\t1, h"),
        0xCD => format!("set\t1, l"),
        0xCE => format!("set\t1, (hl)"),
        0xCF => format!("set\t1, a"),

        0xD0 => format!("set\t2, b"),
        0xD1 => format!("set\t2, c"),
        0xD2 => format!("set\t2, d"),
        0xD3 => format!("set\t2, e"),
        0xD4 => format!("set\t2, h"),
        0xD5 => format!("set\t2, l"),
        0xD6 => format!("set\t2, (hl)"),
        0xD7 => format!("set\t2, a"),
        0xD8 => format!("set\t3, b"),
        0xD9 => format!("set\t3, c"),
        0xDA => format!("set\t3, d"),
        0xDB => format!("set\t3, e"),
        0xDC => format!("set\t3, h"),
        0xDD => format!("set\t3, l"),
        0xDE => format!("set\t3, (hl)"),
        0xDF => format!("set\t3, a"),

        0xE0 => format!("set\t4, b"),
        0xE1 => format!("set\t4, c"),
        0xE2 => format!("set\t4, d"),
        0xE3 => format!("set\t4, e"),
        0xE4 => format!("set\t4, h"),
        0xE5 => format!("set\t4, l"),
        0xE6 => format!("set\t4, (hl)"),
        0xE7 => format!("set\t4, a"),
        0xE8 => format!("set\t5, b"),
        0xE9 => format!("set\t5, c"),
        0xEA => format!("set\t5, d"),
        0xEB => format!("set\t5, e"),
        0xEC => format!("set\t5, h"),
        0xED => format!("set\t5, l"),
        0xEE => format!("set\t5, (hl)"),
        0xEF => format!("set\t5, a"),

        0xF0 => format!("set\t6, b"),
        0xF1 => format!("set\t6, c"),
        0xF2 => format!("set\t6, d"),
        0xF3 => format!("set\t6, e"),
        0xF4 => format!("set\t6, h"),
        0xF5 => format!("set\t6, l"),
        0xF6 => format!("set\t6, (hl)"),
        0xF7 => format!("set\t6, a"),
        0xF8 => format!("set\t7, b"),
        0xF9 => format!("set\t7, c"),
        0xFA => format!("set\t7, d"),
        0xFB => format!("set\t7, e"),
        0xFC => format!("set\t7, h"),
        0xFD => format!("set\t7, l"),
        0xFE => format!("set\t7, (hl)"),
        0xFF => format!("set\t7, a"),

        _ => unreachable!()
    }
}
